<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ° Lottery - å½©ç¥¨ä¸­å¥–æ£€æŸ¥</title>
    <!-- é…ç½®æ–‡ä»¶ -->
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        /* ç™»å½•ç•Œé¢ */
        .login-card {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 400px;
            margin: 100px auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .login-card h2 {
            color: #667eea;
            margin-bottom: 30px;
        }

        .login-card input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logout-btn {
            font-size: 0.8em;
            padding: 6px 12px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        /* å·ç ç»„ */
        .number-groups {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .number-group {
            background: #f7fafc;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }

        .number-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .number-input {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .number-input input {
            width: 60px;
            text-align: center;
        }

        .copies-input {
            width: 80px;
            display: inline-block;
        }

        .ticket-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .ticket-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .ticket-item h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .ticket-numbers {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }

        .ticket-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .ticket-actions button {
            flex: 1;
            padding: 8px;
            font-size: 0.9em;
        }

        /* å†å²å¼€å¥– */
        .draw-history {
            max-height: 500px;
            overflow-y: auto;
        }

        .draw-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }

        .draw-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .success {
            background: #c6f6d5;
            color: #2f855a;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .ticket-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- ç™»å½•ç•Œé¢ -->
        <div id="loginSection" class="login-card">
            <h2>ğŸ° Lottery</h2>
            <p style="color: #666; margin-bottom: 20px;">è¯·è¾“å…¥ Token ç™»å½•</p>
            <input type="password" id="tokenInput" placeholder="è¯·è¾“å…¥ Token">
            <button onclick="login()" class="btn btn-primary" style="width: 100%;">ç™»å½•</button>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div id="mainSection" class="hidden">
            <div class="header">
                <h1>ğŸ° Lottery</h1>
                <p>å½©ç¥¨ä¸­å¥–æ£€æŸ¥å·¥å…·</p>
            </div>

            <div id="message"></div>

            <!-- æ·»åŠ å½©ç¥¨å·ç  -->
            <div class="card">
                <h2 class="card-title">
                    â• æ·»åŠ å½©ç¥¨å·ç 
                    <button onclick="logout()" class="logout-btn">é€€å‡ºç™»å½•</button>
                </h2>
                <form id="addTicketForm">
                    <div class="form-group">
                        <label>å½©ç¥¨ç±»å‹</label>
                        <select id="lotteryType" required>
                            <option value="ssq">åŒè‰²çƒ</option>
                            <option value="dlt">å¤§ä¹é€</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>æ‹¥æœ‰è€…</label>
                        <select id="owner" required>
                            <!-- åŠ¨æ€åŠ è½½ -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label>å·ç ç»„ï¼ˆå¯æ·»åŠ å¤šç»„ï¼‰</label>
                        <div id="numberGroups" class="number-groups">
                            <!-- åŠ¨æ€æ·»åŠ å·ç ç»„ -->
                        </div>
                        <button type="button" onclick="addNumberGroup()" class="btn btn-primary btn-small">
                            â• æ·»åŠ å·ç ç»„
                        </button>
                    </div>

                    <button type="submit" class="btn btn-success">ğŸ’¾ ä¿å­˜æ‰€æœ‰å·ç </button>
                </form>
            </div>

            <!-- å½©ç¥¨åˆ—è¡¨ -->
            <div class="card">
                <h2 class="card-title">ğŸ“‹ æˆ‘çš„å½©ç¥¨</h2>
                <div style="margin-bottom: 15px;">
                    <label style="display: inline-block; margin-right: 10px;">é€‰æ‹©æ‹¥æœ‰è€…ï¼š</label>
                    <select id="ownerFilter" onchange="loadTickets()" style="padding: 8px; border-radius: 4px;">
                        <!-- åŠ¨æ€åŠ è½½ -->
                    </select>
                    <button onclick="loadTickets()" class="btn btn-primary btn-small" style="margin-left: 10px;">
                        ğŸ”„ åˆ·æ–°
                    </button>
                    <button onclick="checkNow()" class="btn btn-success btn-small">ğŸ¯ ç«‹å³æ£€æŸ¥</button>
                </div>
                <div id="ticketList" class="loading">è¯·é€‰æ‹©æ‹¥æœ‰è€…</div>
            </div>

            <!-- æœ€æ–°å¼€å¥–ç»“æœ -->
            <div class="card">
                <h2 class="card-title">ğŸ² å¼€å¥–ç»“æœ</h2>
                <div style="margin-bottom: 15px;">
                    <button onclick="loadLatestDraw('ssq')" class="btn btn-primary btn-small">åŒè‰²çƒæœ€æ–°</button>
                    <button onclick="loadLatestDraw('dlt')" class="btn btn-primary btn-small">å¤§ä¹é€æœ€æ–°</button>
                    <button onclick="loadDrawHistory('ssq')" class="btn btn-primary btn-small">åŒè‰²çƒå†å²</button>
                    <button onclick="loadDrawHistory('dlt')" class="btn btn-primary btn-small">å¤§ä¹é€å†å²</button>
                </div>
                <div id="drawResult"></div>
            </div>
        </div>
    </div>

    <script>
        // ä»é…ç½®æ–‡ä»¶è¯»å– API URL
        const API_URL = LotteryConfig.apiUrl;
        console.log('API URL:', API_URL);

        let API_TOKEN = '';
        let OWNERS = [];
        let currentLotteryType = 'ssq';  // é»˜è®¤åŒè‰²çƒ

        // å½©ç¥¨ç±»å‹é…ç½®
        const lotteryConfig = {
            ssq: {
                name: 'åŒè‰²çƒ',
                frontName: 'çº¢çƒ',
                backName: 'è“çƒ',
                frontCount: 6,
                backCount: 1,
                frontMax: 33,
                backMax: 16
            },
            dlt: {
                name: 'å¤§ä¹é€',
                frontName: 'å‰åŒº',
                backName: 'ååŒº',
                frontCount: 5,
                backCount: 2,
                frontMax: 35,
                backMax: 12
            }
        };

        let numberGroupCounter = 0;

        // ç™»å½•
        async function login() {
            const token = document.getElementById('tokenInput').value.trim();
            if (!token) {
                alert('è¯·è¾“å…¥ Token');
                return;
            }

            API_TOKEN = token;

            // éªŒè¯ Token
            try {
                console.log('æ­£åœ¨è¿æ¥ API æœåŠ¡å™¨...', API_URL);
                await apiRequest('/health');
                console.log('API è¿æ¥æˆåŠŸ');

                // è·å–æ‹¥æœ‰è€…åˆ—è¡¨
                await loadOwners();
                console.log('æ‹¥æœ‰è€…åˆ—è¡¨åŠ è½½æˆåŠŸ');

                // ä¿å­˜ Token
                localStorage.setItem('lottery_token', token);

                // æ˜¾ç¤ºä¸»ç•Œé¢
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainSection').classList.remove('hidden');

                // åˆå§‹åŒ–
                initOwnerSelects();
                addNumberGroup();
                updateNumberInputs();
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                alert('ç™»å½•å¤±è´¥ï¼\n\nå¯èƒ½çš„åŸå› ï¼š\n1. API æœåŠ¡æœªå¯åŠ¨\n2. Token é”™è¯¯\n3. ç½‘ç»œè¿æ¥é—®é¢˜\n\nè¯¦ç»†é”™è¯¯: ' + error.message);
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('lottery_token');
            API_TOKEN = '';
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('mainSection').classList.add('hidden');
            document.getElementById('tokenInput').value = '';
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ Token
        window.onload = function () {
            const savedToken = localStorage.getItem('lottery_token');
            if (savedToken) {
                document.getElementById('tokenInput').value = savedToken;
                login();
            }
        };

        // è·å–æ‹¥æœ‰è€…åˆ—è¡¨
        async function loadOwners() {
            try {
                OWNERS = await apiRequest('/api/config/owners');
            } catch (error) {
                console.error('è·å–æ‹¥æœ‰è€…åˆ—è¡¨å¤±è´¥:', error);
                // ä½¿ç”¨é»˜è®¤åˆ—è¡¨
                OWNERS = ['å¼ ç¿', 'æå››', 'ç‹äº”'];
            }
        }

        // åˆå§‹åŒ–æ‹¥æœ‰è€…é€‰æ‹©æ¡†
        function initOwnerSelects() {
            const ownerSelect = document.getElementById('owner');
            const ownerFilter = document.getElementById('ownerFilter');

            ownerSelect.innerHTML = '';
            ownerFilter.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';

            OWNERS.forEach(owner => {
                const option1 = document.createElement('option');
                option1.value = owner;
                option1.textContent = owner;
                ownerSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = owner;
                option2.textContent = owner;
                ownerFilter.appendChild(option2);
            });
        }

        // æ·»åŠ å·ç ç»„
        function addNumberGroup() {
            const container = document.getElementById('numberGroups');
            const groupId = ++numberGroupCounter;
            const lotteryType = document.getElementById('lotteryType').value;
            const config = lotteryConfig[lotteryType];

            const groupDiv = document.createElement('div');
            groupDiv.className = 'number-group';
            groupDiv.id = `group-${groupId}`;

            groupDiv.innerHTML = `
                <div class="number-group-header">
                    <strong>å·ç ç»„ ${groupId}</strong>
                    <button type="button" onclick="removeNumberGroup(${groupId})" class="btn btn-danger btn-small">
                        åˆ é™¤
                    </button>
                </div>
                <div class="form-group">
                    <label>${config.frontName}ï¼ˆ${config.frontCount}ä¸ªï¼‰</label>
                    <div class="number-input" data-type="front">
                        ${Array(config.frontCount).fill(0).map(() =>
                `<input type="number" min="1" max="${config.frontMax}" required>`
            ).join('')}
                    </div>
                </div>
                <div class="form-group">
                    <label>${config.backName}ï¼ˆ${config.backCount}ä¸ªï¼‰</label>
                    <div class="number-input" data-type="back">
                        ${Array(config.backCount).fill(0).map(() =>
                `<input type="number" min="1" max="${config.backMax}" required>`
            ).join('')}
                    </div>
                </div>
                <div class="form-group">
                    <label>æ³¨æ•°</label>
                    <input type="number" class="copies-input" min="1" value="1" data-copies="true" required>
                    <span style="color: #666; margin-left: 10px;">æ³¨</span>
                </div>
            `;

            container.appendChild(groupDiv);
        }

        // åˆ é™¤å·ç ç»„
        function removeNumberGroup(groupId) {
            const group = document.getElementById(`group-${groupId}`);
            if (group) {
                group.remove();
            }
        }

        // åˆ‡æ¢å½©ç¥¨ç±»å‹
        document.getElementById('lotteryType').addEventListener('change', function () {
            // æ¸…ç©ºå¹¶é‡æ–°æ·»åŠ å·ç ç»„
            document.getElementById('numberGroups').innerHTML = '';
            numberGroupCounter = 0;
            addNumberGroup();
        });

        // æ›´æ–°å·ç è¾“å…¥æ¡†
        function updateNumberInputs() {
            const type = document.getElementById('lotteryType').value;
            const config = lotteryConfig[type];

            // æ›´æ–°æ‰€æœ‰å·ç ç»„
            document.querySelectorAll('.number-group').forEach(group => {
                const frontDiv = group.querySelector('[data-type="front"]');
                const backDiv = group.querySelector('[data-type="back"]');

                frontDiv.innerHTML = Array(config.frontCount).fill(0).map(() =>
                    `<input type="number" min="1" max="${config.frontMax}" required>`
                ).join('');

                backDiv.innerHTML = Array(config.backCount).fill(0).map(() =>
                    `<input type="number" min="1" max="${config.backMax}" required>`
                ).join('');
            });
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.className = type;
            messageDiv.textContent = message;
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 3000);
        }

        // API è¯·æ±‚
        async function apiRequest(url, options = {}) {
            const headers = {
                'Authorization': `Bearer ${API_TOKEN}`,
                'Content-Type': 'application/json',
                ...options.headers
            };

            try {
                const response = await fetch(`${API_URL}${url}`, {
                    ...options,
                    headers,
                    mode: 'cors',  // æ˜ç¡®æŒ‡å®š CORS æ¨¡å¼
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'è¯·æ±‚å¤±è´¥');
                }

                return data.data;
            } catch (error) {
                console.error('API è¯·æ±‚å¤±è´¥:', url, error);
                throw error;
            }
        }

        // æ·»åŠ å½©ç¥¨
        document.getElementById('addTicketForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const lotteryType = document.getElementById('lotteryType').value;
            const owner = document.getElementById('owner').value;

            // è·å–æ‰€æœ‰å·ç ç»„
            const groups = document.querySelectorAll('.number-group');

            if (groups.length === 0) {
                showMessage('è¯·è‡³å°‘æ·»åŠ ä¸€ç»„å·ç ', 'error');
                return;
            }

            try {
                let successCount = 0;

                for (const group of groups) {
                    const frontInputs = group.querySelectorAll('[data-type="front"] input');
                    const backInputs = group.querySelectorAll('[data-type="back"] input');
                    const copiesInput = group.querySelector('[data-copies]');

                    const frontNumbers = Array.from(frontInputs).map(input => parseInt(input.value));
                    const backNumbers = Array.from(backInputs).map(input => parseInt(input.value));
                    const copies = parseInt(copiesInput.value);

                    await apiRequest('/api/tickets', {
                        method: 'POST',
                        body: JSON.stringify({
                            lottery_type: lotteryType,
                            owner,
                            front_numbers: frontNumbers,
                            back_numbers: backNumbers,
                            notes: `${copies}æ³¨`
                        })
                    });

                    successCount++;
                }

                showMessage(`âœ… æˆåŠŸæ·»åŠ  ${successCount} ç»„å½©ç¥¨ï¼`, 'success');
                this.reset();
                document.getElementById('numberGroups').innerHTML = '';
                numberGroupCounter = 0;
                addNumberGroup();
                loadTickets();
            } catch (error) {
                showMessage(`âŒ ${error.message}`, 'error');
            }
        });

        // åŠ è½½å½©ç¥¨åˆ—è¡¨
        async function loadTickets() {
            const owner = document.getElementById('ownerFilter').value;
            const listDiv = document.getElementById('ticketList');

            if (!owner) {
                listDiv.innerHTML = '<p style="text-align: center; color: #999;">è¯·é€‰æ‹©æ‹¥æœ‰è€…</p>';
                return;
            }

            listDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const tickets = await apiRequest(`/api/tickets?owner=${owner}`);

                if (tickets.length === 0) {
                    listDiv.innerHTML = '<p style="text-align: center; color: #999;">æš‚æ— å½©ç¥¨</p>';
                    return;
                }

                listDiv.innerHTML = '';
                const container = document.createElement('div');
                container.className = 'ticket-list';

                tickets.forEach(ticket => {
                    const config = lotteryConfig[ticket.lottery_type];
                    const item = document.createElement('div');
                    item.className = 'ticket-item';

                    const frontNumbers = ticket.front_numbers.map(n => n.toString().padStart(2, '0')).join(', ');
                    const backNumbers = ticket.back_numbers.map(n => n.toString().padStart(2, '0')).join(', ');

                    item.innerHTML = `
                        <h3>${config.name}</h3>
                        <div class="ticket-numbers">
                            ${config.frontName}: ${frontNumbers}<br>
                            ${config.backName}: ${backNumbers}
                        </div>
                        <p style="color: #666; font-size: 0.9em;">${ticket.notes || 'æ— å¤‡æ³¨'}</p>
                        <div class="ticket-actions">
                            <button class="btn btn-danger" onclick="deleteTicket('${ticket.ticket_id}')">åˆ é™¤</button>
                        </div>
                    `;

                    container.appendChild(item);
                });

                listDiv.appendChild(container);
            } catch (error) {
                listDiv.innerHTML = `<p class="error">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }

        // åˆ é™¤å½©ç¥¨
        async function deleteTicket(ticketId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å½©ç¥¨å—ï¼Ÿ')) return;

            try {
                await apiRequest(`/api/tickets/${ticketId}`, {
                    method: 'DELETE'
                });

                showMessage('âœ… å½©ç¥¨åˆ é™¤æˆåŠŸï¼', 'success');
                loadTickets();
            } catch (error) {
                showMessage(`âŒ ${error.message}`, 'error');
            }
        }

        // ç«‹å³æ£€æŸ¥
        async function checkNow() {
            const owner = document.getElementById('ownerFilter').value;
            if (!owner) {
                showMessage('âŒ è¯·å…ˆé€‰æ‹©æ‹¥æœ‰è€…', 'error');
                return;
            }

            try {
                showMessage('ğŸ”„ æ­£åœ¨æ£€æŸ¥...', 'success');

                const result = await apiRequest('/api/check/web', {
                    method: 'POST',
                    body: JSON.stringify({
                        lottery_type: currentLotteryType,
                        owner: owner
                    })
                });

                console.log('æ£€æŸ¥ç»“æœ:', result);  // è°ƒè¯•æ—¥å¿—

                // éªŒè¯è¿”å›æ•°æ®
                if (!result || !result.draw || !result.results) {
                    console.error('è¿”å›æ•°æ®æ ¼å¼é”™è¯¯:', result);
                    showMessage('âŒ è¿”å›æ•°æ®æ ¼å¼é”™è¯¯', 'error');
                    return;
                }

                // æ˜¾ç¤ºæ£€æŸ¥ç»“æœ
                displayCheckResults(result);
            } catch (error) {
                console.error('æ£€æŸ¥å¤±è´¥:', error);
                showMessage(`âŒ ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºæ£€æŸ¥ç»“æœ
        function displayCheckResults(data) {
            try {
                const { draw, results, count } = data;

                if (!draw || !results) {
                    console.error('æ•°æ®ä¸å®Œæ•´:', data);
                    showMessage('âŒ æ•°æ®ä¸å®Œæ•´', 'error');
                    return;
                }

                const config = lotteryConfig[draw.lottery_type];
                if (!config) {
                    console.error('æœªçŸ¥çš„å½©ç¥¨ç±»å‹:', draw.lottery_type);
                    showMessage('âŒ æœªçŸ¥çš„å½©ç¥¨ç±»å‹', 'error');
                    return;
                }

                let winningCount = 0;
                let resultHtml = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0;">ğŸ² ${config.name} ${draw.code}æœŸ</h3>
                        <div style="font-size: 1.1em; font-weight: bold; color: #333;">
                            ${config.frontName}: ${draw.front_numbers.map(n => String(n).padStart(2, '0')).join(', ')} | 
                            ${config.backName}: ${draw.back_numbers.map(n => String(n).padStart(2, '0')).join(', ')}
                        </div>
                        <div style="color: #666; margin-top: 5px;">å¼€å¥–æ—¥æœŸ: ${draw.date}</div>
                    </div>
                    <h3 style="margin: 20px 0 10px 0;">æ£€æŸ¥ç»“æœ (å…± ${count} ç»„)</h3>
                `;

                results.forEach((result, index) => {
                    const isWinning = result.prize !== null && result.prize !== undefined;
                    if (isWinning) winningCount++;

                    const bgColor = isWinning ? '#fff3cd' : '#f8f9fa';
                    const borderColor = isWinning ? '#ffc107' : '#dee2e6';
                    const prizeText = isWinning ? `<strong style="color: #d63031; font-size: 1.2em;">ğŸ‰ ${result.prize}</strong>` : '<span style="color: #999;">æœªä¸­å¥–</span>';

                    resultHtml += `
                    <div style="background: ${bgColor}; border: 2px solid ${borderColor}; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: bold;">ç¬¬ ${index + 1} ç»„</span>
                            ${prizeText}
                        </div>
                        <div style="color: #666;">
                            ${config.frontName}: ${result.ticket_front_numbers.map(n => String(n).padStart(2, '0')).join(', ')} | 
                            ${config.backName}: ${result.ticket_back_numbers.map(n => String(n).padStart(2, '0')).join(', ')}
                        </div>
                        <div style="color: #999; font-size: 0.9em; margin-top: 5px;">
                            åŒ¹é…: ${config.frontName} ${result.front_match_count}/${result.ticket_front_numbers.length} | 
                            ${config.backName} ${result.back_match_count}/${result.ticket_back_numbers.length}
                        </div>
                    </div>
                `;
                });

                if (winningCount > 0) {
                    showMessage(`ğŸ‰ æ­å–œï¼æœ‰ ${winningCount} ç»„ä¸­å¥–ï¼`, 'success');
                } else {
                    showMessage('æœªä¸­å¥–ï¼Œç»§ç»­åŠ æ²¹ï¼', 'info');
                }

                // æ˜¾ç¤ºåœ¨å¼€å¥–ç»“æœåŒºåŸŸ
                const resultDiv = document.getElementById('drawResult');
                if (!resultDiv) {
                    console.error('æ‰¾ä¸åˆ° drawResult å…ƒç´ ');
                    return;
                }
                resultDiv.innerHTML = resultHtml;

                console.log('æ£€æŸ¥ç»“æœå·²æ˜¾ç¤º');
            } catch (error) {
                console.error('æ˜¾ç¤ºæ£€æŸ¥ç»“æœå¤±è´¥:', error);
                showMessage(`âŒ æ˜¾ç¤ºç»“æœå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½æœ€æ–°å¼€å¥–ç»“æœ
        async function loadLatestDraw(lotteryType) {
            const resultDiv = document.getElementById('drawResult');
            resultDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const draw = await apiRequest(`/api/draws/latest/${lotteryType}`);
                const config = lotteryConfig[lotteryType];

                const frontNumbers = draw.front_numbers.map(n => n.toString().padStart(2, '0')).join(', ');
                const backNumbers = draw.back_numbers.map(n => n.toString().padStart(2, '0')).join(', ');

                // ä½¿ç”¨è¡¨æ ¼å±•ç¤ºæœ€æ–°å¼€å¥–
                resultDiv.innerHTML = `
                    <h3 style="margin-bottom: 15px;">${config.name} æœ€æ–°å¼€å¥–</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background-color: #f5f5f5; border-bottom: 2px solid #ddd;">
                                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">æœŸå·</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">æ—¥æœŸ</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">${config.frontName}</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">${config.backName}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background-color: #fff;">
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd; font-weight: bold; font-size: 16px;">${draw.code}</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${draw.date}</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #e74c3c; font-weight: bold; font-size: 16px;">${frontNumbers}</td>
                                    <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #3498db; font-weight: bold; font-size: 16px;">${backNumbers}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }

        // åŠ è½½å†å²å¼€å¥–ç»“æœ
        async function loadDrawHistory(lotteryType) {
            const resultDiv = document.getElementById('drawResult');
            resultDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const draws = await apiRequest(`/api/draws?lottery_type=${lotteryType}&limit=10`);
                const config = lotteryConfig[lotteryType];

                if (draws.length === 0) {
                    resultDiv.innerHTML = '<p style="text-align: center; color: #999;">æš‚æ— å†å²è®°å½•</p>';
                    return;
                }

                // ä½¿ç”¨è¡¨æ ¼å±•ç¤ºï¼Œæ›´ç´§å‡‘
                let tableHTML = `
                    <h3 style="margin-bottom: 15px;">${config.name} æœ€è¿‘10æœŸ</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background-color: #f5f5f5; border-bottom: 2px solid #ddd;">
                                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">æœŸå·</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">æ—¥æœŸ</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">${config.frontName}</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">${config.backName}</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                draws.forEach((draw, index) => {
                    const frontNumbers = draw.front_numbers.map(n => n.toString().padStart(2, '0')).join(', ');
                    const backNumbers = draw.back_numbers.map(n => n.toString().padStart(2, '0')).join(', ');
                    const bgColor = index % 2 === 0 ? '#fff' : '#f9f9f9';

                    tableHTML += `
                        <tr style="background-color: ${bgColor};">
                            <td style="padding: 8px; text-align: center; border: 1px solid #ddd; font-weight: bold;">${draw.code}</td>
                            <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${draw.date}</td>
                            <td style="padding: 8px; text-align: center; border: 1px solid #ddd; color: #e74c3c; font-weight: bold;">${frontNumbers}</td>
                            <td style="padding: 8px; text-align: center; border: 1px solid #ddd; color: #3498db; font-weight: bold;">${backNumbers}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;

                resultDiv.innerHTML = tableHTML;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }
    </script>
</body>

</html>